/*CREATE FLAGS FOR DAYS WITH PEAK VALUES OF DIFFERENT METRICS*/
PROC SQL;
	CREATE TABLE STORE.MODEL_FINAL AS
	SELECT MF.*, HOSP.PEAK_HOSPITAL_OCCUPANCY, ICU.PEAK_ICU_OCCUPANCY, VENT.PEAK_VENT_OCCUPANCY, 
		ECMO.PEAK_ECMO_OCCUPANCY, DIAL.PEAK_DIAL_OCCUPANCY, I.PEAK_INFECTIONS, FATAL.PEAK_FATALITY
	FROM STORE.MODEL_FINAL MF
		LEFT JOIN
			(SELECT *
				FROM (SELECT MODELTYPE, SCENARIONAMEUNIQUE, DATE, HOSPITAL_OCCUPANCY, 1 AS PEAK_HOSPITAL_OCCUPANCY
					FROM STORE.MODEL_FINAL
					GROUP BY 1, 2
					HAVING HOSPITAL_OCCUPANCY=MAX(HOSPITAL_OCCUPANCY)
					) 
				GROUP BY MODELTYPE, SCENARIONAMEUNIQUE
				HAVING DATE=MIN(DATE)
			) HOSP
			ON MF.MODELTYPE = HOSP.MODELTYPE
				AND MF.SCENARIONAMEUNIQUE = HOSP.SCENARIONAMEUNIQUE
				AND MF.DATE = HOSP.DATE
		LEFT JOIN
			(SELECT * FROM
				(SELECT MODELTYPE, SCENARIONAMEUNIQUE, DATE, ICU_OCCUPANCY, 1 AS PEAK_ICU_OCCUPANCY
				FROM STORE.MODEL_FINAL
				GROUP BY 1, 2
				HAVING ICU_OCCUPANCY=MAX(ICU_OCCUPANCY)) 
			GROUP BY MODELTYPE, SCENARIONAMEUNIQUE
			HAVING DATE=MIN(DATE)) ICU
			ON MF.MODELTYPE = ICU.MODELTYPE
				AND MF.SCENARIONAMEUNIQUE = ICU.SCENARIONAMEUNIQUE
				AND MF.DATE = ICU.DATE
		LEFT JOIN
			(SELECT * FROM
				(SELECT MODELTYPE, SCENARIONAMEUNIQUE, DATE, VENT_OCCUPANCY, 1 AS PEAK_VENT_OCCUPANCY
				FROM STORE.MODEL_FINAL
				GROUP BY 1, 2
				HAVING VENT_OCCUPANCY=MAX(VENT_OCCUPANCY)) 
			GROUP BY MODELTYPE, SCENARIONAMEUNIQUE
			HAVING DATE=MIN(DATE)) VENT
			ON MF.MODELTYPE = VENT.MODELTYPE
				AND MF.SCENARIONAMEUNIQUE = VENT.SCENARIONAMEUNIQUE
				AND MF.DATE = VENT.DATE
		LEFT JOIN
			(SELECT * FROM
				(SELECT MODELTYPE, SCENARIONAMEUNIQUE, DATE, ECMO_OCCUPANCY, 1 AS PEAK_ECMO_OCCUPANCY
				FROM STORE.MODEL_FINAL
				GROUP BY 1, 2
				HAVING ECMO_OCCUPANCY=MAX(ECMO_OCCUPANCY)) 
			GROUP BY MODELTYPE, SCENARIONAMEUNIQUE
			HAVING DATE=MIN(DATE)) ECMO
			ON MF.MODELTYPE = ECMO.MODELTYPE
				AND MF.SCENARIONAMEUNIQUE = ECMO.SCENARIONAMEUNIQUE
				AND MF.DATE = ECMO.DATE
		LEFT JOIN
			(SELECT * FROM
				(SELECT MODELTYPE, SCENARIONAMEUNIQUE, DATE, DIAL_OCCUPANCY, 1 AS PEAK_DIAL_OCCUPANCY
				FROM STORE.MODEL_FINAL
				GROUP BY 1, 2
				HAVING DIAL_OCCUPANCY=MAX(DIAL_OCCUPANCY)) 
			GROUP BY MODELTYPE, SCENARIONAMEUNIQUE
			HAVING DATE=MIN(DATE)) DIAL
			ON MF.MODELTYPE = DIAL.MODELTYPE
				AND MF.SCENARIONAMEUNIQUE = DIAL.SCENARIONAMEUNIQUE
				AND MF.DATE = DIAL.DATE
		LEFT JOIN
			(SELECT * FROM
				(SELECT MODELTYPE, SCENARIONAMEUNIQUE, DATE, I_N, 1 AS PEAK_INFECTIONS
				FROM STORE.MODEL_FINAL
				GROUP BY 1, 2
				HAVING I_N=MAX(I_N)) 
			GROUP BY MODELTYPE, SCENARIONAMEUNIQUE
			HAVING DATE=MIN(DATE)) I
			ON MF.MODELTYPE = I.MODELTYPE
				AND MF.SCENARIONAMEUNIQUE = I.SCENARIONAMEUNIQUE
				AND MF.DATE = I.DATE
		LEFT JOIN
			(SELECT * FROM
				(SELECT MODELTYPE, SCENARIONAMEUNIQUE, DATE, FATALITY, 1 AS PEAK_FATALITY
				FROM STORE.MODEL_FINAL
				GROUP BY 1, 2
				HAVING FATALITY=MAX(FATALITY)) 
			GROUP BY MODELTYPE, SCENARIONAMEUNIQUE
			HAVING DATE=MIN(DATE)) FATAL
			ON MF.MODELTYPE = FATAL.MODELTYPE
				AND MF.SCENARIONAMEUNIQUE = FATAL.SCENARIONAMEUNIQUE
				AND MF.DATE = FATAL.DATE
	ORDER BY SCENARIONAMEUNIQUE, MODELTYPE, DATE;
QUIT;